// <ppj name="Moveta.Intern" date="1/17/2024 7:59:41 AM" id="F4EC85BAD2BF79AC25C9F8643540E90F9BE1DAF0"/>
// ======================================================================================================
// This code was generated by the Ice Porter(tm) Tool version 4.8.15.0
// Ice Porter is part of The Porting Project (PPJ) by Ice Tea Group, LLC.
// The generated code is not guaranteed to be accurate and to compile without
// manual modifications.
// 
// ICE TEA GROUP LLC SHALL IN NO EVENT BE LIABLE FOR ANY DAMAGES WHATSOEVER
// (INCLUDING, WITHOUT LIMITATION, DAMAGES FOR LOSS OF BUSINESS PROFITS, BUSINESS
// INTERRUPTION, LOSS OF BUSINESS INFORMATION, OR ANY OTHER LOSS OF ANY KIND)
// ARISING OUT OF THE USE OR INABILITY TO USE THE GENERATED CODE, WHETHER
// DIRECT, INDIRECT, INCIDENTAL, CONSEQUENTIAL, SPECIAL OR OTHERWISE, REGARDLESS
// OF THE FORM OF ACTION, EVEN IF ICE TEA GROUP LLC HAS BEEN ADVISED OF THE
// POSSIBILITY OF SUCH DAMAGES.
// =====================================================================================================
using System;
using System.Text;
using System.Drawing;
using System.Diagnostics;
using System.Collections;
using System.Windows.Forms;
using System.ComponentModel;
using MT;
using PPJ.Runtime;
using PPJ.Runtime.Com;
using PPJ.Runtime.Sql;
using PPJ.Runtime.Vis;
using PPJ.Runtime.Windows;
using PPJ.Runtime.Windows.QO;
using PPJ.Runtime.XSal;

namespace Moveta.Intern
{
	
	/// <summary>
	/// neue Halter anlegen
	/// </summary>
	/// <param name="nArztNr"></param>
	/// <param name="strBearbeiter"></param>
	/// <param name="dtBearbDatum"></param>
	/// <param name="bAuto"></param>
	public partial class frmHalterAnl : SalFormWindow
	{
		#region Window Parameters
		public SalNumber nArztNr;
		public SalString strBearbeiter;
		public SalDateTime dtBearbDatum;
		public SalBoolean bAuto;
		#endregion
		
		#region Window Variables
		public SalSqlHandle hSqlLe = SalSqlHandle.Null;
		public SalString strSelect = "";
		public SalString strSelect2 = "";
		public SalString strROWIDLe = "";
		public SalString strROWIDHa = "";
		public SalString strMatch = "";
		public SalString strTi = "";
		public SalString strVN = "";
		public SalString strNN = "";
		public SalString strName2 = "";
		public SalString strStr = "";
		public SalString strOrt = "";
		public SalString strLand = "";
		public SalString strAnrede = "";
		public SalString strHTel = "";
		public SalString strHTel2 = "";
		public SalString strHTelHandy = "";
		public SalString strHTelFax = "";
		public SalString strHEmail = "";
		public SalNumber nFetch = 0;
		public SalNumber nPosNr = 0;
		public SalNumber nFaellTg = 0;
		public SalNumber nMahnInt = 0;
		public SalNumber nBankEinzug = 0;
		public SalNumber nProz1 = 0;
		public SalNumber nProz2 = 0;
		public SalNumber nProz3 = 0;
		public SalNumber nHalterNr = 0;
		public SalNumber nHalterNr2 = 0;
		public SalBoolean bHaDa = false;
		public SalNumber nArztNr2 = 0;
		public SalString strPraxArt = "";
		public SalBoolean bExists = false;
		public SalNumber nSkonto = 0;
		public SalString strKuerzel = "";
		public SalString strTATi = "";
		public SalString strTAVN = "";
		public SalString strTANN = "";
		public SalString strTAN2 = "";
		public SalString strTAStr = "";
		public SalString strTAOrt = "";
		public SalString strTALand = "";
		public SalDateTime dtTAErfDat = SalDateTime.Null;
		public SalString strTVTi = "";
		public SalString strTVVN = "";
		public SalString strTVNN = "";
		public SalString strTVN2 = "";
		public SalString strTVStr = "";
		public SalString strTVOrt = "";
		public SalString strTVLand = "";
		public SalDateTime dtTVErfDat = SalDateTime.Null;
		public SalString strTAxTi = "";
		public SalString strTAxVN = "";
		public SalString strTAxNN = "";
		public SalString strTAxN2 = "";
		public SalString strTAxStr = "";
		public SalString strTAxOrt = "";
		public SalString strTVxN2 = "";
		public SalString strTVxStr = "";
		public SalString strTVxOrt = "";
		public SalString lsLong = "";
		public SalNumber nResult = 0;
		public SalSqlHandle hSqlPI = SalSqlHandle.Null;
		public SalNumber nFetchPI = 0;
		public SalNumber nHauptNr = 0;
		public SalNumber nHauptNrAlt = 0;
		public SalNumber nNebenNr = 0;
		public SalString strAerzte = "";
		public SalNumber nReverse = 0;
		public SalString strUStID = "";
		public SalString strNeben = "";
		public SalNumber nDeaktiv = 0;
		public SalString strKennungTA = "";
		public SalNumber nHalterNein = 0;
		public SalString strVeCode = "";
		public SalString strVeVSNr = "";
		#endregion
		
		#region Constructors/Destructors
		
		/// <summary>
		/// Default Constructor.
		/// </summary>
		public frmHalterAnl(SalNumber nArztNr, SalString strBearbeiter, SalDateTime dtBearbDatum, SalBoolean bAuto)
		{
			// Assign global reference.
			App.frmHalterAnl = this;
			// Window Parameters initialization.
			this.nArztNr = nArztNr;
			this.strBearbeiter = strBearbeiter;
			this.dtBearbDatum = dtBearbDatum;
			this.bAuto = bAuto;
			// This call is required by the Windows Form Designer.
			InitializeComponent();
		}
		#endregion
		
		#region System Methods/Properties
		
		/// <summary>
		/// Shows the form window.
		/// </summary>
		/// <param name="owner"></param>
		/// <returns></returns>
		public static frmHalterAnl CreateWindow(Control owner, SalNumber nArztNr, SalString strBearbeiter, SalDateTime dtBearbDatum, SalBoolean bAuto)
		{
			frmHalterAnl frm = new frmHalterAnl(nArztNr, strBearbeiter, dtBearbDatum, bAuto);
			frm.Show(owner);
			return frm;
		}
		
		/// <summary>
		/// Returns the object instance associated with the window handle.
		/// </summary>
		/// <param name="handle"></param>
		/// <returns></returns>
		[DebuggerStepThrough]
		public static frmHalterAnl FromHandle(SalWindowHandle handle)
		{
			return ((frmHalterAnl)SalWindow.FromHandle(handle, typeof(frmHalterAnl)));
		}
		#endregion
		
		#region Window Actions
		
		/// <summary>
		/// frmHalterAnl WindowActions Handler
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="e"></param>
		private void frmHalterAnl_WindowActions(object sender, WindowActionsEventArgs e)
		{
			#region Actions
			switch (e.ActionType)
			{
				case Sys.SAM_Create:
					this.frmHalterAnl_OnSAM_Create(sender, e);
					break;
				
				case Sys.SAM_Destroy:
					this.frmHalterAnl_OnSAM_Destroy(sender, e);
					break;

				//FC:FINAL:#47 - moved from SAM_Create
                case Sys.SAM_CreateComplete:
                    e.Handled = true;
                    Sal.WaitCursor(false);
                    if (this.bAuto)
                    {
                        //FC:FINAL:#47 - send message instead of post nessage
                        this.pbAnlegen.SendMessage(Sys.SAM_Click, 0, 0);
                    }
                    break;
            }
			#endregion
		}
		
		/// <summary>
		/// SAM_Create event handler.
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="e"></param>
		private void frmHalterAnl_OnSAM_Create(object sender, WindowActionsEventArgs e)
		{
			#region Actions
			e.Handled = true;
			this.dfArztNr.Number = this.nArztNr;
			Int.SqlImmedSel(@"SELECT AKZPRAXART,ANR2 INTO :frmHalterAnl.strPraxArt,:frmHalterAnl.nArztNr2
FROM A WHERE AARZTNR = :frmHalterAnl.dfArztNr");
			if (this.strPraxArt == "2") 
			{
				this.dfArztNr2.Number = this.nArztNr;
				this.dfArztNr.Number = this.nArztNr2;
				this.nArztNr = this.dfArztNr.Number;
				this.nArztNr2 = this.dfArztNr2.Number;
			}
			else if (this.strPraxArt == "1") 
			{
				this.dfArztNr2.Number = this.nArztNr2;
				this.dfArztNr.Number = this.nArztNr;
			}
			Int.SqlConnection(ref this.hSqlLe);

			Sal.WaitCursor(false);
			//FC:FINAL:#47 - moved to SAM_CreateComplete
			//if (this.bAuto) 
			//{
			//	this.pbAnlegen.PostMessage(Sys.SAM_Click, 0, 0);
			//}
			#endregion
		}
		
		/// <summary>
		/// SAM_Destroy event handler.
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="e"></param>
		private void frmHalterAnl_OnSAM_Destroy(object sender, WindowActionsEventArgs e)
		{
			#region Actions
			e.Handled = true;
			this.hSqlLe.Disconnect();
			#endregion
		}
		
		/// <summary>
		/// pbAnlegen WindowActions Handler
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="e"></param>
		private void pbAnlegen_WindowActions(object sender, WindowActionsEventArgs e)
		{
			#region Actions
			switch (e.ActionType)
			{
				case Sys.SAM_Click:
					this.pbAnlegen_OnSAM_Click(sender, e);
					break;
			}
			#endregion
		}
		
		/// <summary>
		/// SAM_Click event handler.
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="e"></param>
		private void pbAnlegen_OnSAM_Click(object sender, WindowActionsEventArgs e)
		{
			#region Actions
			e.Handled = true;
			Int.SqlIstDa(" FROM A WHERE AARZTNR = :frmHalterAnl.nArztNr", ref this.bExists);
			if (!(this.bExists)) 
			{
				Sal.MessageBox(@"Dieser Arzt ist
noch gar nicht angelegt !", "Fehler", (Sys.MB_Ok | Sys.MB_IconExclamation));
                //FC:FINAL#47 - Änderung Destroy zu Close
                //this.DestroyWindow();
				this.Close();
			}
			else
			{
				// 05.08.09 OTÄ298
				this.nHauptNr = 0;
				this.nHauptNrAlt = 0;
				if (this.dfArztNr2.Number == 0 || this.dfArztNr2.Number == Sys.NUMBER_Null) 
				{
					this.strAerzte = "= " + this.dfArztNr.Number.ToString(0);
				}
				else
				{
					this.strAerzte = "in ( " + this.dfArztNr.Number.ToString(0) + ", " + this.dfArztNr2.Number.ToString(0) + ")";
				}
				Int.SqlConnection(ref this.hSqlPI);
				Int.SqlHandleExec(this.hSqlPI, @"SELECT pihauptnr, pinebennr
FROM pi
INTO :frmHalterAnl.nHauptNr, :frmHalterAnl.nNebenNr
WHERE pihauptnr " + this.strAerzte + @"
OR pinebennr " + this.strAerzte, "Fehler Holen PackInfo", ref Var.nErr);
				this.strNeben = "";
				this.nFetchPI = this.hSqlPI.FetchNext();
				while (this.nFetchPI != Sys.FETCH_EOF) 
				{
					if (this.nHauptNr != this.nHauptNrAlt) 
					{
						if (this.dfArztNr.Number != this.nHauptNr && this.dfArztNr2.Number != this.nHauptNr) 
						{
							this.strNeben = this.strNeben + ", " + this.nHauptNr.ToString(0) + ", " + this.nNebenNr.ToString(0);
						}
						this.nHauptNrAlt = this.nHauptNr;
					}
					this.nFetchPI = this.hSqlPI.FetchNext();
				}
				this.hSqlPI.Commit();
				this.hSqlPI.Disconnect();

				Int.SqlImmedSel(@"SELECT afaelltg, amahnint, askonto, aproz1, aproz2, aproz3
INTO :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt, :frmHalterAnl.nSkonto,
:frmHalterAnl.nProz1,  :frmHalterAnl.nProz2,  :frmHalterAnl.nProz3
FROM A WHERE AARZTNR = :frmHalterAnl.nArztNr");
				this.SetStatusBarText("Halternummern werden geprüft");
				Int.SqlImmedX(@"UPDATE LE SET lehalternr = 0
WHERE learztnr=:frmHalterAnl.nArztNr
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum
AND NOT EXISTS ( SELECT * FROM H WHERE harztnr=learztnr AND hhalternr = lehalternr)");
				Int.SqlImmedX(@"UPDATE LEP SET lephalternr = 0
WHERE leparztnr=:frmHalterAnl.nArztNr
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum
AND NOT EXISTS ( SELECT * FROM H WHERE harztnr=leparztnr AND hhalternr = lephalternr)");
				// 19.03.10 OTÄ397 + hreverse, hustid
				this.strSelect = @"SELECT leti, levn, lenn,lename2,lestr,leort,leposnr, leherfdat, lereverse, leustid, ROWID,
LEHTEL, LEHTEL2, LEHTELHANDY, LEHTELFAX, LEHEMAIL
INTO :frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN, :frmHalterAnl.strName2,
:frmHalterAnl.strStr, :frmHalterAnl.strOrt, :frmHalterAnl.nPosNr, :frmHalterAnl.dtTAErfDat, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID, :frmHalterAnl.strROWIDLe,
:frmHalterAnl.strHTel, :frmHalterAnl.strHTel2, :frmHalterAnl.strHTelHandy, :frmHalterAnl.strHTelFax, :frmHalterAnl.strHEmail
FROM LE WHERE learztnr=:frmHalterAnl.nArztNr
AND lehalternr = 0
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum
ORDER BY leposnr";
				Sal.WaitCursor(true);
				Int.SqlHandleExec(this.hSqlLe, this.strSelect, "Fehler", ref Var.nCount);
				this.nFetch = this.hSqlLe.FetchNext();
				while (this.nFetch != Sys.FETCH_EOF) 
				{
					this.nHalterNr = 0;
					// 01.09.00
					if (!(this.bAuto)) 
					{
						// 13.04.06 auskommentiert
						// If dtTAErfDat != DATETIME_Null
						// Call SqlImmedSel('SELECT HHALTERNR, hti, hvn, hnn, hname2, hstr, hort FROM H INTO :frmHalterAnl.nHalterNr,
						// :frmHalterAnl.strTVTi, :frmHalterAnl.strTVVN, :frmHalterAnl.strTVNN, :frmHalterAnl.strTVN2, :frmHalterAnl.strTVStr, :frmHalterAnl.strTVOrt
						// WHERE harztnr=:frmHalterAnl.dfArztNr AND herfdat = :frmHalterAnl.dtTAErfDat')
						// If nHalterNr != 0
						// Set strTAxTi = SalStrUpperX(PalDelBlank(strTi))
						// Set strTAxVN = SalStrUpperX(PalDelBlank(strVN))
						// Set strTAxNN = SalStrUpperX(PalDelBlank(strNN))
						// Set strTAxN2 = SalStrUpperX(PalDelBlank(strName2))
						// Set strTAxStr = SalStrUpperX(PalDelBlank(strStr))
						// Set strTAxOrt = SalStrUpperX(PalDelBlank(strOrt))
						// Set strTVxTi = SalStrUpperX(PalDelBlank(strTVTi))
						// Set strTVxVN = SalStrUpperX(PalDelBlank(strTVVN))
						// Set strTVxNN = SalStrUpperX(PalDelBlank(strTVNN))
						// Set strTVxN2 = SalStrUpperX(PalDelBlank(strTVN2))
						// Set strTVxStr = SalStrUpperX(PalDelBlank(strTVStr))
						// Set strTVxOrt = SalStrUpperX(PalDelBlank(strTVOrt))
						// If strTAxTi=strTVxTi and strTAxVN=strTVxVN and strTAxNN=strTVxNN and strTAxN2=strTVxN2 and strTAxStr=strTVxStr and strTAxOrt=strTVxOrt
						// Set nResult = 99
						// Else
						// Set nResult =  SalMessageBox('TA :  ' || strNN || ', ' || strVN || ' ' || strTi || ', ' || strName2 || ', ' || strStr || ', ' || strOrt || '
						// 
						// TV :  ' || strTVNN || ', ' || strTVVN || ' ' || strTVTi  || ', ' || strTVN2 || ', ' || strTVStr || ', ' || strTVOrt || '
						// 
						// Kunde identifiziert. Ist das i.O. ?' , 'Achtung !' , MB_YesNo|MB_IconQuestion)
						// If nResult = IDYES
						// Call SqlImmedX('UPDATE H SET
						// hti = :frmHalterAnl.strTi,
						// hvn = :frmHalterAnl.strVN,
						// hnn = :frmHalterAnl.strNN,
						// hname2 = :frmHalterAnl.strName2,
						// hstr = :frmHalterAnl.strStr,
						// hort = :frmHalterAnl.strOrt
						// WHERE harztnr=:frmHalterAnl.dfArztNr AND hhalternr = :frmHalterAnl.nHalterNr')
						// Set strKuerzel = SalStrLeftX( frmMain.strUser, 2)
						// Set lsLong = '***** automatische HS-Änderung aufgrund Identifikation von
						// 
						// ' || strTVNN || ', ' || strTVVN || ' ' || strTVTi  || '
						// ' || strTVN2 || '
						// ' ||  strTVStr || '
						// ' ||  strTVOrt || '
						// 
						// in :
						// 
						// ' || strNN || ', ' || strVN || ' ' || strTi  || '
						// ' || strName2 || '
						// ' ||  strStr || '
						// ' ||  strOrt || '
						// ' || PalDateToStr(dtTAErfDat)
						// Call SqlImmed('
						// INSERT INTO Z VALUES (:strBNZei, \'*\', :frmHalterAnl.dfArztNr, :frmHalterAnl.nHalterNr, 0,
						// :frmHalterAnl.lsLong , SYSDATE, NULL, \'J\', \'HS\', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,1)')
						// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
						// WHERE ROWID = :frmHalterAnl.strROWIDLe')
						// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
						// WHERE leparztnr=:frmHalterAnl.nArztNr
						// AND lepposnr = :frmHalterAnl.nPosNr
						// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
						// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
						// Call SalStatusSetText(hWndForm,'alte Nr. '||SalNumberToStrX(nHalterNr,0))
						// Else If nResult = 99
						// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
						// WHERE ROWID = :frmHalterAnl.strROWIDLe')
						// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
						// WHERE leparztnr=:frmHalterAnl.nArztNr
						// AND lepposnr = :frmHalterAnl.nPosNr
						// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
						// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
						// Call SalStatusSetText(hWndForm,'alte Nr. '||SalNumberToStrX(nHalterNr,0))
						// Else
						// 24.10.00
						// Call SqlImmedX('UPDATE H SET herfdat = NULL
						// WHERE harztnr=:frmHalterAnl.dfArztNr AND hhalternr = :frmHalterAnl.nHalterNr')
						// Set nHalterNr = 0
					}
					// 21.10.22 F4923 + Pal
					this.strVN = Int.PalStringStrip(this.strVN, ((SalNumber)10).ToCharacter());
					this.strNN = Int.PalStringStrip(this.strNN, ((SalNumber)10).ToCharacter());
					this.strName2 = Int.PalStringStrip(this.strName2, ((SalNumber)10).ToCharacter());
					this.strStr = Int.PalStringStrip(this.strStr, ((SalNumber)10).ToCharacter());
					this.strOrt = Int.PalStringStrip(this.strOrt, ((SalNumber)10).ToCharacter());

					Int.PalTrimFeld(ref this.strTi);
					Int.PalTrimFeld(ref this.strVN);
					Int.PalTrimFeld(ref this.strNN);
					Int.PalTrimFeld(ref this.strStr);
					this.strLand = Int.PalGetLand(ref this.strOrt);
					Int.PalTrimOrtUK(ref this.strOrt, this.strLand); // 01.02.16 Ä1168
					// 16.01.03
					// 07.08.23 Ä2107 Versicherung
					this.strVeCode = "";
					this.strVeVSNr = "";
					this.strSelect2 = "SELECT hhalternr, hvecode, hvevsnr INTO :frmHalterAnl.nHalterNr, :frmHalterAnl.strVeCode, :frmHalterAnl.strVeVSNr FROM H WHERE harztnr=:frmHalterAnl.dfArztNr ";
					// 05.04.13 F1622
					// If strTi = ''
					// Set strSelect2 = strSelect2 || ' AND hti IS NULL'
					// Else
					// Set strSelect2 = strSelect2 || ' AND hti = :frmHalterAnl.strTi'
					if (this.strNN == "") 
					{
						this.strSelect2 = this.strSelect2 + " AND hnn IS NULL";
					}
					else
					{
						this.strSelect2 = this.strSelect2 + " AND hnn = :frmHalterAnl.strNN";
					}
					if (this.strVN == "") 
					{
						this.strSelect2 = this.strSelect2 + " AND hvn IS NULL";
					}
					else
					{
						this.strSelect2 = this.strSelect2 + " AND hvn= :frmHalterAnl.strVN";
					}
					if (this.strName2 == "") 
					{
						this.strSelect2 = this.strSelect2 + " AND hname2 IS NULL";
					}
					else
					{
						this.strSelect2 = this.strSelect2 + " AND hname2= :frmHalterAnl.strName2";
					}
					if (this.strStr == "") 
					{
						this.strSelect2 = this.strSelect2 + " AND hstr IS NULL";
					}
					else
					{
						this.strSelect2 = this.strSelect2 + " AND hstr= :frmHalterAnl.strStr";
					}
					if (this.strOrt == "") 
					{
						this.strSelect2 = this.strSelect2 + " AND hort IS NULL";
					}
					else
					{
						this.strSelect2 = this.strSelect2 + " AND hort= :frmHalterAnl.strOrt";
					}
					this.strSelect2 = this.strSelect2 + " AND hland= :frmHalterAnl.strLand";
					// If strNN = 'Brüggemann'
					// Call SalMessageBox( strTi || SalNumberToStrX(  SalStrLength( strTi ),0) || '
					// ' || strVN || SalNumberToStrX(  SalStrLength( strVN ),0) || '
					// ' || strNN || SalNumberToStrX(  SalStrLength( strNN ),0) || '
					// ' || strName2 || SalNumberToStrX(  SalStrLength( strName2 ),0) || '
					// ' || strStr || SalNumberToStrX(  SalStrLength( strStr ),0) || '
					// ' || strOrt || SalNumberToStrX(  SalStrLength( strOrt ),0) || '
					// ' || strLand || SalNumberToStrX(  SalStrLength( strLand ),0), '', MB_Ok )
					this.nHalterNr = 0;
					// 17.08.21
					// Call SqlImmedSel(strSelect2)
					Int.SqlImmedSel(this.strSelect2 + " AND (hhalternein=0 OR hhalternein IS NULL)");
					// If strVN = 'Heinrich' and strNN = 'Schmidt'
					// Call SalMessageBeep( 0 )
					if (this.nHalterNr == 0) 
					{
						Int.SqlImmedSel(this.strSelect2);
					}

					if (this.nHalterNr != 0) 
					{
						// 30.09.21 F4810
						// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
						// WHERE ROWID = :frmHalterAnl.strROWIDLe')
						// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
						// WHERE leparztnr=:frmHalterAnl.nArztNr
						// AND lepposnr = :frmHalterAnl.nPosNr
						// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
						// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
						// 07.08.23 Ä2107 Versicherung
						Int.SqlImmedX(@"UPDATE LE SET
LEHALTERNR = :frmHalterAnl.nHalterNr,
LEVECODE = :frmHalterAnl.strVeCode,
LEVEVSNR = :frmHalterAnl.strVeVSNr
WHERE learztnr " + this.strAerzte + @"
AND leposnr = :frmHalterAnl.nPosNr
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
						Int.SqlImmedX(@"UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
WHERE leparztnr " + this.strAerzte + @"
AND lepposnr = :frmHalterAnl.nPosNr
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");

						this.SetStatusBarText("alte Nr. nach Name " + this.nHalterNr.ToString(0));
						Int.PalLog("HPrüf1 " + this.nHalterNr.ToString(0) + " " + this.strTi + " " + this.strNN + " " + this.strVN + " " + this.strName2 + " " + this.strStr + " " + this.strOrt + " " + this.strLand);
						// ! 12.02.19 Ä1825
						if (this.nDeaktiv == 1) 
						{
							Int.SqlImmed("UPDATE h SET hdeaktiv = NULL WHERE hhalternr=:frmHalterAnl.nHalterNr AND harztnr=:frmHalterAnl.dfArztNr ");
						}
						// !
					}

					if (this.nHalterNr == 0) 
					{
						// 13.04.06 + AND hland = :frmHalterAnl.strLand
						// 07.08.23 Ä2107 Versicherung
						this.strVeCode = "";
						this.strVeVSNr = "";
						this.strSelect2 = @"SELECT HHALTERNR, hvecode, hvevsnr FROM H INTO :frmHalterAnl.nHalterNr, :frmHalterAnl.strVeCode, :frmHalterAnl.strVeVSNr
WHERE harztnr=:frmHalterAnl.dfArztNr AND @LICS(@TRIM(hti)) = @LICS(@TRIM(:frmHalterAnl.strTi))
AND @LICS(@TRIM(hnn)) = @LICS(@TRIM(:frmHalterAnl.strNN))
AND @LICS(@TRIM(hstr)) = @LICS(@TRIM(:frmHalterAnl.strStr))
AND @LICS(@TRIM(hort)) = @LICS(@TRIM(:frmHalterAnl.strOrt))
AND hland = :frmHalterAnl.strLand";
						if (this.strTAN2 == "") 
						{
							this.strSelect2 = this.strSelect2 + " AND hname2 IS NULL";
						}
						else
						{
							this.strSelect2 = this.strSelect2 + " AND @LICS(@TRIM(hname2)) = @LICS(@TRIM(:frmHalterAnl.strName2)) ";
						}
						// 12.11.02
						if (this.strVN == "") 
						{
							this.strSelect2 = this.strSelect2 + " AND hvn IS NULL";
						}
						else
						{
							this.strSelect2 = this.strSelect2 + " AND @LICS(@TRIM(hvn)) = @LICS(@TRIM(:frmHalterAnl.strVN)) ";
						}

						Int.SqlImmedSel(this.strSelect2);
						if (this.nHalterNr != 0) 
						{
							// 30.09.21 F4810
							// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
							// WHERE ROWID = :frmHalterAnl.strROWIDLe')
							// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
							// WHERE leparztnr=:frmHalterAnl.nArztNr
							// AND lepposnr = :frmHalterAnl.nPosNr
							// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
							// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
							// 07.08.23 Ä2107 Versicherung
							Int.SqlImmedX(@"UPDATE LE SET
LEHALTERNR = :frmHalterAnl.nHalterNr,
LEVECODE = :frmHalterAnl.strVeCode,
LEVEVSNR = :frmHalterAnl.strVeVSNr
WHERE learztnr " + this.strAerzte + @"
AND leposnr = :frmHalterAnl.nPosNr
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
							Int.SqlImmedX(@"UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
WHERE leparztnr " + this.strAerzte + @"
AND lepposnr = :frmHalterAnl.nPosNr
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");

							Int.SqlImmedX(@"UPDATE H SET
herfdat = :frmHalterAnl.dtTAErfDat
WHERE harztnr=:frmHalterAnl.dfArztNr AND hhalternr = :frmHalterAnl.nHalterNr");
							this.SetStatusBarText("alte Nr. " + this.nHalterNr.ToString(0));
							Int.PalLog("HPrüf2 " + this.nHalterNr.ToString(0) + " " + this.strTi + " " + this.strNN + " " + this.strVN + " " + this.strName2 + " " + this.strStr + " " + this.strOrt + " " + this.strLand);
							// ! 12.02.19 Ä1825
							if (this.nDeaktiv == 1) 
							{
								Int.SqlImmed("UPDATE h SET hdeaktiv = NULL WHERE hhalternr=:frmHalterAnl.nHalterNr AND harztnr=:frmHalterAnl.dfArztNr ");
							}
							// !
						}
						else
						{
							if (!(this.bAuto)) 
							{
								// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr WHERE harztnr=:frmHalterAnl.dfArztNr AND hhalternr<10000')
								// If nHalterNr = 9999
								// 04.09.12 Ä811
								// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr WHERE harztnr=:frmHalterAnl.dfArztNr')
								// If Not SalIsNull(dfArztNr2)
								// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr2 WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr<10000')
								// If nHalterNr2 = 9999
								// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr2 WHERE harztnr=:frmHalterAnl.dfArztNr2')
								// If nHalterNr2>nHalterNr
								// Set nHalterNr = nHalterNr2
								// Set nHalterNr = nHalterNr +1
								this.nHalterNr = Int.PalGetNewHalterNr(this.dfArztNr.Number, this.dfArztNr2.Number, this.strNeben);

								// 08.09.03
								// 19.03.10 OTÄ397 + hreverse, hustid
								if (this.nHalterNr >= 100000) 
								{
									Sal.MessageBox(@"Neue Halter-Nr. wäre größer als 99999. Das ist nicht erlaubt.
Halter kann nicht angelegt werden!", "Fehler", (Sys.MB_IconStop | Sys.MB_Ok));
								}
								else if (this.nHalterNr == 0)  // 04.09.12 Ä811
								{
									Sal.MessageBox(@"Es ist keine Halter-Nr. mehr frei.
Halter kann nicht angelegt werden!", "Fehler", (Sys.MB_IconStop | Sys.MB_Ok));
								}
								else
								{
									// If strMatch = ''
									// Call SalModalDialog(dlgMatch, hWndForm)
									if (Int.PalValNum(this.strMatch) != 0) 
									{
										this.nHalterNr = Int.PalValNum(this.strMatch);
										Int.SqlImmedX(@"UPDATE H SET herfdat = :frmHalterAnl.dtTAErfDat
WHERE harztnr=:frmHalterAnl.dfArztNr AND hhalternr = :frmHalterAnl.nHalterNr");
									}
									else
									{
										this.strAnrede = "";
										Int.PalCheckVN(ref this.strVN, ref this.strAnrede, ref this.strName2);
										if (this.strAnrede == "") 
										{
											this.strAnrede = "Herrn/Frau/Firma";
										}
										// 29.09.21 SqlistDa
										Int.SqlIstDa("FROM h WHERE harztnr = :frmHalterAnl.dfArztNr AND hhalternr = :frmHalterAnl.nHalterNr", ref this.bExists);
										if (!(this.bExists)) 
										{
											// 17.09.21 Ä1969 + Herkunft
											Int.SqlImmedX(@"INSERT INTO H (harztnr, hhalternr, hti, hvn, hnn, hname2, hstr, hort, hland, hfaelltg, hmahnint, htitel,
hproz1, hproz2, hproz3, hskonto, herfdat, hbankeinzug, hetikett, hreverse, hustid,
hhtel, hhtel2, hhtelhandy, hhtelfax, hhemail, haendherkunft, haendherkunftdat)
VALUES(:frmHalterAnl.dfArztNr,:frmHalterAnl.nHalterNr,:frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN,:frmHalterAnl.strName2,
:frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.strLand, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
:frmHalterAnl.strAnrede,
:frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3, :frmHalterAnl.nSkonto,:frmHalterAnl.dtTAErfDat, 0,0, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID,
:frmHalterAnl.strHTel, :frmHalterAnl.strHTel2, :frmHalterAnl.strHTelHandy, :frmHalterAnl.strHTelFax, :frmHalterAnl.strHEmail,
'Tierarztpraxis', SYSDATETIME)");
										}
										if (!(this.dfArztNr2.IsEmpty())) 
										{
											// 29.09.21 SqlistDa
											Int.SqlIstDa("FROM h WHERE harztnr = :frmHalterAnl.dfArztNr2 AND hhalternr = :frmHalterAnl.nHalterNr", ref this.bExists);
											if (!(this.bExists)) 
											{
												Int.SqlImmedX(@"INSERT INTO H (harztnr, hhalternr, hti, hvn, hnn, hname2, hstr, hort, hland, hfaelltg, hmahnint, htitel,
hproz1, hproz2, hproz3, hskonto, herfdat, hbankeinzug, hetikett, hreverse, hustid,
hhtel, hhtel2, hhtelhandy, hhtelfax, hhemail, haendherkunft, haendherkunftdat)
VALUES(:frmHalterAnl.dfArztNr2,:frmHalterAnl.nHalterNr,:frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN,:frmHalterAnl.strName2,
:frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.strLand, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
:frmHalterAnl.strAnrede,
:frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3, :frmHalterAnl.nSkonto,:frmHalterAnl.dtTAErfDat, 0,0, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID,
:frmHalterAnl.strHTel, :frmHalterAnl.strHTel2, :frmHalterAnl.strHTelHandy, :frmHalterAnl.strHTelFax, :frmHalterAnl.strHEmail,
'Tierarztpraxis', SYSDATETIME)");
											}
										}
										// 05.08.09 OTÄ298
										this.nHauptNr = 0;
										this.nHauptNrAlt = 0;
										if (this.dfArztNr2.Number == 0 || this.dfArztNr2.Number == Sys.NUMBER_Null) 
										{
											this.strAerzte = "= " + this.dfArztNr.Number.ToString(0);
										}
										else
										{
											this.strAerzte = "in ( " + this.dfArztNr.Number.ToString(0) + ", " + this.dfArztNr2.Number.ToString(0) + ")";
										}
										Int.SqlConnection(ref this.hSqlPI);
										Int.SqlHandleExec(this.hSqlPI, @"SELECT pihauptnr, pinebennr
FROM pi
INTO :frmHalterAnl.nHauptNr, :frmHalterAnl.nNebenNr
WHERE pihauptnr " + this.strAerzte + @"
OR pinebennr " + this.strAerzte, "Fehler Holen PackInfo", ref Var.nErr);
										this.nFetchPI = this.hSqlPI.FetchNext();
										while (this.nFetchPI != Sys.FETCH_EOF) 
										{
											if (this.nHauptNr != this.nHauptNrAlt) 
											{
												if (this.dfArztNr.Number != this.nHauptNr && this.dfArztNr2.Number != this.nHauptNr) 
												{
													Int.SqlIstDa("FROM h WHERE harztnr = :frmHalterAnl.nHauptNr AND hhalternr = :frmHalterAnl.nHalterNr", ref this.bExists); // 29.01.13 F1518
													if (!(this.bExists)) 
													{
														Int.SqlImmedX(@"INSERT INTO H (harztnr, hhalternr, hti, hvn, hnn, hname2, hstr, hort, hland, hfaelltg, hmahnint, htitel,
hproz1, hproz2, hproz3, hskonto, herfdat, hbankeinzug, hetikett, hreverse, hustid,
hhtel, hhtel2, hhtelhandy, hhtelfax, hhemail, haendherkunft, haendherkunftdat)
VALUES(:frmHalterAnl.nHauptNr,:frmHalterAnl.nHalterNr,:frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN,:frmHalterAnl.strName2,
:frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.strLand, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
:frmHalterAnl.strAnrede,
:frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3, :frmHalterAnl.nSkonto,:frmHalterAnl.dtTAErfDat, 0,0, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID,
:frmHalterAnl.strHTel, :frmHalterAnl.strHTel2, :frmHalterAnl.strHTelHandy, :frmHalterAnl.strHTelFax, :frmHalterAnl.strHEmail,
'Tierarztpraxis', SYSDATETIME)");
													}
												}
												this.nHauptNrAlt = this.nHauptNr;
											}
											if (this.dfArztNr.Number == this.nNebenNr || this.dfArztNr2.Number == this.nNebenNr) 
											{
											}
											else
											{
												Int.SqlIstDa("FROM h WHERE harztnr = :frmHalterAnl.nNebenNr AND hhalternr = :frmHalterAnl.nHalterNr", ref this.bExists); // 29.01.13 F1518
												if (!(this.bExists)) 
												{
													Int.SqlImmedX(@"INSERT INTO H (harztnr, hhalternr, hti, hvn, hnn, hname2, hstr, hort, hland, hfaelltg, hmahnint, htitel,
hproz1, hproz2, hproz3, hskonto, herfdat, hbankeinzug, hetikett, hreverse, hustid,
hhtel, hhtel2, hhtelhandy, hhtelfax, hhemail, haendherkunft, haendherkunftdat)
VALUES(:frmHalterAnl.nNebenNr,:frmHalterAnl.nHalterNr,:frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN,:frmHalterAnl.strName2,
:frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.strLand, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
:frmHalterAnl.strAnrede,
:frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3, :frmHalterAnl.nSkonto,:frmHalterAnl.dtTAErfDat, 0,0, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID,
:frmHalterAnl.strHTel, :frmHalterAnl.strHTel2, :frmHalterAnl.strHTelHandy, :frmHalterAnl.strHTelFax, :frmHalterAnl.strHEmail,
'Tierarztpraxis', SYSDATETIME)");
												}
											}
											this.nFetchPI = this.hSqlPI.FetchNext();
										}
										this.hSqlPI.Commit();
										this.hSqlPI.Disconnect();

									}
									// Call SqlImmedX('UPDATE LE SET
									// LEHALTERNR = :frmHalterAnl.nHalterNr,
									// LEMATCH = :frmHalterAnl.strMatch
									// WHERE ROWID = :frmHalterAnl.strROWIDLe')
									// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
									// WHERE leparztnr=:frmHalterAnl.nArztNr
									// AND lepposnr = :frmHalterAnl.nPosNr
									// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
									// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
									// TB #6
									Int.SqlImmedX(@"UPDATE LE SET
LEHALTERNR = :frmHalterAnl.nHalterNr
WHERE learztnr IN (:frmHalterAnl.nArztNr, :frmHalterAnl.nArztNr2)
AND leposnr = :frmHalterAnl.nPosNr
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
									Int.SqlImmedX(@"UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
WHERE leparztnr IN (:frmHalterAnl.nArztNr, :frmHalterAnl.nArztNr2)
AND lepposnr = :frmHalterAnl.nPosNr
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
									this.SetStatusBarText("neue Nr. " + this.nHalterNr.ToString(0));
								}
							}
							Int.PalLog("HPrüfX " + this.nHalterNr.ToString(0) + " " + this.strTi + " " + this.strNN + " " + this.strVN + " " + this.strName2 + " " + this.strStr + " " + this.strOrt + " " + this.strLand);
						}
					}
					this.nFetch = this.hSqlLe.FetchNext();
				}
				this.hSqlLe.Commit();
				if (!(this.dfArztNr2.IsEmpty())) 
				{
					Int.SqlImmedSel(@"SELECT afaelltg, amahnint, askonto, aproz1, aproz2, aproz3
INTO :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt, :frmHalterAnl.nSkonto,
:frmHalterAnl.nProz1,  :frmHalterAnl.nProz2,  :frmHalterAnl.nProz3
FROM A WHERE AARZTNR = :frmHalterAnl.nArztNr2");
					this.SetStatusBarText("Halternummern werden geprüft");
					Int.SqlImmedX(@"UPDATE LE SET lehalternr = 0
WHERE learztnr=:frmHalterAnl.nArztNr2
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum
AND NOT EXISTS ( SELECT * FROM H WHERE harztnr=learztnr AND hhalternr = lehalternr)");
					Int.SqlImmedX(@"UPDATE LEP SET lephalternr = 0
WHERE leparztnr=:frmHalterAnl.nArztNr2
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum
AND NOT EXISTS ( SELECT * FROM H WHERE harztnr=leparztnr AND hhalternr = lephalternr)");
					this.strSelect = @"SELECT leti, levn, lenn,lename2,lestr,leort,leposnr, leherfdat,ROWID
INTO :frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN, :frmHalterAnl.strName2,
:frmHalterAnl.strStr, :frmHalterAnl.strOrt, :frmHalterAnl.nPosNr, :frmHalterAnl.dtTAErfDat, :frmHalterAnl.strROWIDLe
FROM LE WHERE learztnr=:frmHalterAnl.nArztNr2
AND lehalternr = 0
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum
ORDER BY leposnr";
					Sal.WaitCursor(true);
					Int.SqlHandleExec(this.hSqlLe, this.strSelect, "Fehler", ref Var.nCount);
					this.nFetch = this.hSqlLe.FetchNext();
					while (this.nFetch != Sys.FETCH_EOF) 
					{
						this.nHalterNr = 0;
						// If strVN = 'Heinrich' and strNN = 'Schmidt'
						// Call SalMessageBeep( 0 )
						// If SalStrTrimX( strNN ) = 'Dallmayr'
						// Call SalMessageBeep( 0 )
						// 01.09.00
						if (!(this.bAuto)) 
						{
							// 13.04.06 auskommentiert
							if (this.dtTAErfDat != SalDateTime.Null) 
							{
								Int.SqlImmedSel(@"SELECT HHALTERNR, hti, hvn, hnn, hname2, hstr, hort FROM H INTO :frmHalterAnl.nHalterNr,
:frmHalterAnl.strTVTi, :frmHalterAnl.strTVVN, :frmHalterAnl.strTVNN, :frmHalterAnl.strTVN2, :frmHalterAnl.strTVStr, :frmHalterAnl.strTVOrt
WHERE harztnr=:frmHalterAnl.dfArztNr2 AND herfdat = :frmHalterAnl.dtTAErfDat");
								if (this.nHalterNr != 0) 
								{
									this.strTAxTi = Int.PalDelBlank(this.strTi).ToUpper();
									this.strTAxVN = Int.PalDelBlank(this.strVN).ToUpper();
									this.strTAxNN = Int.PalDelBlank(this.strNN).ToUpper();
									this.strTAxN2 = Int.PalDelBlank(this.strName2).ToUpper();
									this.strTAxStr = Int.PalDelBlank(this.strStr).ToUpper();
									this.strTAxOrt = Int.PalDelBlank(this.strOrt).ToUpper();
									App.frmDiskAbr.strTVxTi = Int.PalDelBlank(this.strTVTi).ToUpper();
									App.frmDiskAbr.strTVxVN = Int.PalDelBlank(this.strTVVN).ToUpper();
									App.frmDiskAbr.strTVxNN = Int.PalDelBlank(this.strTVNN).ToUpper();
									this.strTVxN2 = Int.PalDelBlank(this.strTVN2).ToUpper();
									this.strTVxStr = Int.PalDelBlank(this.strTVStr).ToUpper();
									this.strTVxOrt = Int.PalDelBlank(this.strTVOrt).ToUpper();
									if (this.strTAxTi == App.frmDiskAbr.strTVxTi && this.strTAxVN == App.frmDiskAbr.strTVxVN && this.strTAxNN == App.frmDiskAbr.strTVxNN && this.strTAxN2 == this.strTVxN2 && this.strTAxStr == this.strTVxStr && this.strTAxOrt == this.strTVxOrt) 
									{
										this.nResult = 99;
									}
									else
									{
										this.nResult = Sal.MessageBox("TA :  " + this.strNN + ", " + this.strVN + " " + this.strTi + ", " + this.strName2 + ", " + this.strStr + ", " + this.strOrt + @"

TV :  " + this.strTVNN + ", " + this.strTVVN + " " + this.strTVTi + ", " + this.strTVN2 + ", " + this.strTVStr + ", " + this.strTVOrt + @"

Kunde identifiziert. Ist das i.O. ?", "Achtung !", (Sys.MB_YesNo | Sys.MB_IconQuestion));
									}
									if (this.nResult == Sys.IDYES) 
									{
										Int.SqlImmedX(@"UPDATE H SET
hti = :frmHalterAnl.strTi,
hvn = :frmHalterAnl.strVN,
hnn = :frmHalterAnl.strNN,
hname2 = :frmHalterAnl.strName2,
hstr = :frmHalterAnl.strStr,
hort = :frmHalterAnl.strOrt,
hhtel = :frmHalterAnl.strHTel,
hhtel2 = :frmHalterAnl.strHTel2,
hhtelhandy = :frmHalterAnl.strHTelHandy,
hhtelfax = :frmHalterAnl.strHTelFax,
hhemail = :frmHalterAnl.strHEmail
WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr = :frmHalterAnl.nHalterNr");
										// 17.09.21 Ä1969 + Herkunft
										Int.SqlImmedX("UPDATE h SET haendherkunft = \'Tierarztpraxis\', haendherkunftdat = SYSDATETIME WHERE harztnr = :frmHalterAnl.dfArztNr2 AND hhalternr = :frmHalterAnl.nHalterNr");

										this.strKuerzel = App.frmMain.strUser.Left(2);
										this.lsLong = @"***** automatische HS-Änderung aufgrund Identifikation von

" + this.strTVNN + ", " + this.strTVVN + " " + this.strTVTi + @"
" + this.strTVN2 + @"
" + this.strTVStr + @"
" + this.strTVOrt + @"

in :

" + this.strNN + ", " + this.strVN + " " + this.strTi + @"
" + this.strName2 + @"
" + this.strStr + @"
" + this.strOrt + @"
" + Int.PalDateToStr(this.dtTAErfDat);
										// 13.05.14 F2027
										this.nHalterNr = Int.PalCheckNULL(this.nHalterNr);

										Int.SqlImmed(@"
INSERT INTO Z (zvon, zan, zarztnr, zhalternr, zrechnr, zbemerk, zdatum, zwiedervor, zerledigt, zart, zzm, zzmdm, zproznr, zan0, zan1, zan2, zan3, zan4, zanzeige, zerfdat)
VALUES (:strBNZei, '*', :frmHalterAnl.dfArztNr2, :frmHalterAnl.nHalterNr, 0,
:frmHalterAnl.lsLong , SYSDATE, NULL, 'J', 'HS', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,1, SYSDATETIME)");
										// 30.09.21 F4810
										// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
										// WHERE ROWID = :frmHalterAnl.strROWIDLe')
										// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
										// WHERE leparztnr=:frmHalterAnl.nArztNr2
										// AND lepposnr = :frmHalterAnl.nPosNr
										// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
										// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
										Int.SqlImmedX(@"UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
WHERE learztnr " + this.strAerzte + @"
AND leposnr = :frmHalterAnl.nPosNr
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
										Int.SqlImmedX(@"UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
WHERE leparztnr " + this.strAerzte + @"
AND lepposnr = :frmHalterAnl.nPosNr
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");

										this.SetStatusBarText("alte Nr. " + this.nHalterNr.ToString(0));
									}
									else if (this.nResult == 99) 
									{
										// 30.09.21 F4810
										// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
										// WHERE ROWID = :frmHalterAnl.strROWIDLe')
										// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
										// WHERE leparztnr=:frmHalterAnl.nArztNr2
										// AND lepposnr = :frmHalterAnl.nPosNr
										// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
										// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
										Int.SqlImmedX(@"UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
WHERE learztnr " + this.strAerzte + @"
AND leposnr = :frmHalterAnl.nPosNr
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
										Int.SqlImmedX(@"UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
WHERE leparztnr " + this.strAerzte + @"
AND lepposnr = :frmHalterAnl.nPosNr
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");

										this.SetStatusBarText("alte Nr. " + this.nHalterNr.ToString(0));
										// ! 12.02.19 Ä1825
										Int.SqlImmed("UPDATE h SET hdeaktiv = NULL WHERE hhalternr=:frmHalterAnl.nHalterNr AND harztnr=:frmHalterAnl.nArztNr2 ");
										// !
									}
									else
									{
										// 24.10.00
										Int.SqlImmedX(@"UPDATE H SET herfdat = NULL
WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr = :frmHalterAnl.nHalterNr");

										this.nHalterNr = 0;
									}
								}
							}
						}
						Int.PalTrimFeld(ref this.strTi);
						Int.PalTrimFeld(ref this.strVN);
						Int.PalTrimFeld(ref this.strNN);
						Int.PalTrimFeld(ref this.strStr);
						this.strLand = Int.PalGetLand(ref this.strOrt);
						Int.PalTrimOrtUK(ref this.strOrt, this.strLand); // 01.02.16 Ä1168
						// 16.01.03
						// 07.08.23 Ä2107 Versicherung
						this.strVeCode = "";
						this.strVeVSNr = "";
						this.strSelect2 = "SELECT hhalternr, hvecode, hvevsnr INTO :frmHalterAnl.nHalterNr, :frmHalterAnl.strVeCode, :frmHalterAnl.strVeVSNr FROM H WHERE harztnr=:frmHalterAnl.dfArztNr2 ";
						// 15.10.19 auskommentiert
						// If strTi = ''
						// Set strSelect2 = strSelect2 || ' AND hti IS NULL'
						// Else
						// Set strSelect2 = strSelect2 || ' AND hti = :frmHalterAnl.strTi'
						if (this.strNN == "") 
						{
							this.strSelect2 = this.strSelect2 + " AND hnn IS NULL";
						}
						else
						{
							this.strSelect2 = this.strSelect2 + " AND hnn = :frmHalterAnl.strNN";
						}
						if (this.strVN == "") 
						{
							this.strSelect2 = this.strSelect2 + " AND hvn IS NULL";
						}
						else
						{
							this.strSelect2 = this.strSelect2 + " AND hvn= :frmHalterAnl.strVN";
						}
						if (this.strName2 == "") 
						{
							this.strSelect2 = this.strSelect2 + " AND hname2 IS NULL";
						}
						else
						{
							this.strSelect2 = this.strSelect2 + " AND hname2= :frmHalterAnl.strName2";
						}
						if (this.strStr == "") 
						{
							this.strSelect2 = this.strSelect2 + " AND hstr IS NULL";
						}
						else
						{
							this.strSelect2 = this.strSelect2 + " AND hstr= :frmHalterAnl.strStr";
						}
						if (this.strOrt == "") 
						{
							this.strSelect2 = this.strSelect2 + " AND hort IS NULL";
						}
						else
						{
							this.strSelect2 = this.strSelect2 + " AND hort= :frmHalterAnl.strOrt";
						}
						this.strSelect2 = this.strSelect2 + " AND hland= :frmHalterAnl.strLand";
						this.nHalterNr = 0;
						// 17.08.21
						// Call SqlImmedSel(strSelect2)
						Int.SqlImmedSel(this.strSelect2 + " AND (hhalternein=0 OR hhalternein IS NULL)");
						if (this.nHalterNr == 0) 
						{
							Int.SqlImmedSel(this.strSelect2);
						}

						if (this.nHalterNr != 0) 
						{
							// 30.09.21 F4810
							// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
							// WHERE ROWID = :frmHalterAnl.strROWIDLe')
							// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
							// WHERE leparztnr=:frmHalterAnl.nArztNr2
							// AND lepposnr = :frmHalterAnl.nPosNr
							// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
							// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
							// 07.08.23 Ä2107 Versicherung
							Int.SqlImmedX(@"UPDATE LE SET
LEHALTERNR = :frmHalterAnl.nHalterNr,
LEVECODE = :frmHalterAnl.strVeCode,
LEVEVSNR = :frmHalterAnl.strVeVSNr
WHERE learztnr " + this.strAerzte + @"
AND leposnr = :frmHalterAnl.nPosNr
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
							Int.SqlImmedX(@"UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
WHERE leparztnr " + this.strAerzte + @"
AND lepposnr = :frmHalterAnl.nPosNr
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");

							this.SetStatusBarText("alte Nr. nach Name " + this.nHalterNr.ToString(0));
							// ! 12.02.19 Ä1825
							if (this.nDeaktiv == 1) 
							{
								Int.SqlImmed("UPDATE h SET hdeaktiv = NULL WHERE hhalternr=:frmHalterAnl.nHalterNr AND harztnr=:frmHalterAnl.nArztNr2 ");
							}
							// !
						}

						if (this.nHalterNr == 0) 
						{
							// 13.04.06 + AND hland = :frmHalterAnl.strLand
							// 07.08.23 Ä2107 Versicherung
							this.strVeCode = "";
							this.strVeVSNr = "";
							this.strSelect2 = "SELECT hhalternr, hvecode, hvevsnr INTO :frmHalterAnl.nHalterNr, :frmHalterAnl.strVeCode, :frmHalterAnl.strVeVSNr FROM H WHERE harztnr=:frmHalterAnl.dfArztNr2 ";
							this.strSelect2 = @"SELECT HHALTERNR, hvecode, hvevsnr FROM H INTO :frmHalterAnl.nHalterNr, :frmHalterAnl.strVeCode, :frmHalterAnl.strVeVSNr
WHERE harztnr=:frmHalterAnl.dfArztNr2 AND @LICS(@TRIM(hti)) = @LICS(@TRIM(:frmHalterAnl.strTi))
AND @LICS(@TRIM(hvn)) = @LICS(@TRIM(:frmHalterAnl.strVN))
AND @LICS(@TRIM(hnn)) = @LICS(@TRIM(:frmHalterAnl.strNN))
AND @LICS(@TRIM(hstr)) = @LICS(@TRIM(:frmHalterAnl.strStr))
AND @LICS(@TRIM(hort)) = @LICS(@TRIM(:frmHalterAnl.strOrt))
AND hland = :frmHalterAnl.strLand";
							if (this.strTAN2 == "") 
							{
								this.strSelect2 = this.strSelect2 + " AND hname2 IS NULL";
							}
							else
							{
								this.strSelect2 = this.strSelect2 + " AND @LICS(@TRIM(hname2)) = @LICS(@TRIM(:frmHalterAnl.strName2)) ";
							}
							Int.SqlImmedSel(this.strSelect2);
							if (this.nHalterNr != 0) 
							{
								// 30.09.21 F4810
								// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
								// WHERE ROWID = :frmHalterAnl.strROWIDLe')
								// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
								// WHERE leparztnr=:frmHalterAnl.nArztNr2
								// AND lepposnr = :frmHalterAnl.nPosNr
								// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
								// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
								// 07.08.23 Ä2107 Versicherung
								Int.SqlImmedX(@"UPDATE LE SET
LEHALTERNR = :frmHalterAnl.nHalterNr,
LEVECODE = :frmHalterAnl.strVeCode,
LEVEVSNR = :frmHalterAnl.strVeVSNr
WHERE learztnr " + this.strAerzte + @"
AND leposnr = :frmHalterAnl.nPosNr
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
								Int.SqlImmedX(@"UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
WHERE leparztnr " + this.strAerzte + @"
AND lepposnr = :frmHalterAnl.nPosNr
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");

								Int.SqlImmedX(@"UPDATE H SET
herfdat = :frmHalterAnl.dtTAErfDat
WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr = :frmHalterAnl.nHalterNr");
								this.SetStatusBarText("alte Nr. " + this.nHalterNr.ToString(0));
								// ! 12.02.19 Ä1825
								if (this.nDeaktiv == 1) 
								{
									Int.SqlImmed("UPDATE h SET hdeaktiv = NULL WHERE hhalternr=:frmHalterAnl.nHalterNr AND harztnr=:frmHalterAnl.nArztNr2 ");
								}
								// !
							}
							else
							{
								if (!(this.bAuto)) 
								{
									// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr<10000')
									// If nHalterNr = 9999
									// 04.09.12 811
									// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr WHERE harztnr=:frmHalterAnl.dfArztNr2')
									// If Not SalIsNull(dfArztNr)
									// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr2 WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr<10000')
									// If nHalterNr2 = 9999
									// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr2 WHERE harztnr=:frmHalterAnl.dfArztNr')
									// If nHalterNr2>nHalterNr
									// Set nHalterNr = nHalterNr2
									// Set nHalterNr = nHalterNr +1
									this.nHalterNr = Int.PalGetNewHalterNr(this.dfArztNr.Number, this.dfArztNr2.Number, this.strNeben);

									// 08.09.03
									if (this.nHalterNr >= 100000) 
									{
										Sal.MessageBox(@"Neue Halter-Nr. wäre größer als 99999. Das ist nicht erlaubt.
Halter kann nicht angelegt werden!", "Fehler", (Sys.MB_IconStop | Sys.MB_Ok));
									}
									else if (this.nHalterNr == 0)  // 04.09.12 Ä811
									{
										Sal.MessageBox(@"Es ist keine Halter-Nr. mehr frei.
Halter kann nicht angelegt werden!", "Fehler", (Sys.MB_IconStop | Sys.MB_Ok));
									}
									else
									{
										// If strMatch = ''
										// Call SalModalDialog(dlgMatch, hWndForm)
										if (Int.PalValNum(this.strMatch) != 0) 
										{
											this.nHalterNr = Int.PalValNum(this.strMatch);
											Int.SqlImmedX(@"UPDATE H SET herfdat = :frmHalterAnl.dtTAErfDat
WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr = :frmHalterAnl.nHalterNr");
										}
										else
										{
											this.strAnrede = "";
											Int.PalCheckVN(ref this.strVN, ref this.strAnrede, ref this.strName2);
											if (this.strAnrede == "") 
											{
												this.strAnrede = "Herrn/Frau/Firma";
											}
											Int.SqlImmedX(@"INSERT INTO H (harztnr, hhalternr, hti, hvn, hnn, hname2, hstr, hort, hland, hfaelltg, hmahnint, htitel,
hproz1, hproz2, hproz3, hskonto, herfdat, hbankeinzug, hetikett, hreverse, hustid)
VALUES(:frmHalterAnl.dfArztNr2,:frmHalterAnl.nHalterNr,:frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN,:frmHalterAnl.strName2,
:frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.strLand, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
:frmHalterAnl.strAnrede,
:frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3, :frmHalterAnl.nSkonto,:frmHalterAnl.dtTAErfDat, 0,0, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID)");
											// 17.09.21 Ä1969 + Herkunft
											// Call SqlImmedX('INSERT INTO H (harztnr, hhalternr, hti, hvn, hnn, hname2, hstr, hort, hland, hfaelltg, hmahnint, htitel,
											// hproz1, hproz2, hproz3, hskonto, herfdat, hbankeinzug, hetikett, hreverse, hustid,
											// hhtel, hhtel2, hhtelhandy, hhtelfax, hhemail, haendherkunft, haendherkunftdat)
											// VALUES(:frmHalterAnl.dfArztNr,:frmHalterAnl.nHalterNr,:frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN,:frmHalterAnl.strName2,
											// :frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.strLand, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
											// :frmHalterAnl.strAnrede,
											// :frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3, :frmHalterAnl.nSkonto,:frmHalterAnl.dtTAErfDat, 0,0, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID,
											// :frmHalterAnl.strHTel, :frmHalterAnl.strHTel2, :frmHalterAnl.strHTelHandy, :frmHalterAnl.strHTelFax, :frmHalterAnl.strHEmail,
											// \'Tierarztpraxis\', SYSDATETIME)')
											if (!(this.dfArztNr.IsEmpty())) 
											{
												Int.SqlImmedX(@"INSERT INTO H (harztnr, hhalternr, hti, hvn, hnn, hname2, hstr, hort, hland, hfaelltg, hmahnint, htitel,
hproz1, hproz2, hproz3, hskonto, herfdat, hbankeinzug,hetikett, hreverse, hustid)
VALUES(:frmHalterAnl.dfArztNr,:frmHalterAnl.nHalterNr,:frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN,:frmHalterAnl.strName2,
:frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.strLand, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
:frmHalterAnl.strAnrede,
:frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3, :frmHalterAnl.nSkonto,:frmHalterAnl.dtTAErfDat, 0,0, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID)");
											}
											// 05.08.09 OTÄ298
											this.nHauptNr = 0;
											this.nHauptNrAlt = 0;
											Int.SqlConnection(ref this.hSqlPI);
											Int.SqlHandleExec(this.hSqlPI, @"SELECT pihauptnr, pinebennr
FROM pi
INTO :frmHalterAnl.nHauptNr, :frmHalterAnl.nNebenNr
WHERE pihauptnr in ( " + this.dfArztNr.Number.ToString(0) + ", " + this.dfArztNr2.Number.ToString(0) + @")
OR pinebennr in ( " + this.dfArztNr.Number.ToString(0) + ", " + this.dfArztNr2.Number.ToString(0) + ")", "Fehler Holen PackInfo", ref Var.nErr);
											this.nFetchPI = this.hSqlPI.FetchNext();
											while (this.nFetchPI != Sys.FETCH_EOF) 
											{
												if (this.nHauptNr != this.nHauptNrAlt) 
												{
													if (this.dfArztNr.Number != this.nHauptNr && this.dfArztNr2.Number != this.nHauptNr) 
													{
														Int.SqlImmedX(@"INSERT INTO H (harztnr, hhalternr, hti, hvn, hnn, hname2, hstr, hort, hland, hfaelltg, hmahnint, htitel,
hproz1, hproz2, hproz3, hskonto, herfdat, hbankeinzug, hetikett, hreverse, hustid, haendherkunft, haendherkunftdat)
VALUES(:frmHalterAnl.nHauptNr,:frmHalterAnl.nHalterNr,:frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN,:frmHalterAnl.strName2,
:frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.strLand, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
:frmHalterAnl.strAnrede,
:frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3, :frmHalterAnl.nSkonto,:frmHalterAnl.dtTAErfDat, 0,0, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID,
'Tierarztpraxis', SYSDATETIME)");
													}
													this.nHauptNrAlt = this.nHauptNr;
												}
												if (this.dfArztNr.Number == this.nNebenNr || this.dfArztNr2.Number == this.nNebenNr) 
												{
												}
												else
												{
													Int.SqlImmedX(@"INSERT INTO H (harztnr, hhalternr, hti, hvn, hnn, hname2, hstr, hort, hland, hfaelltg, hmahnint, htitel,
hproz1, hproz2, hproz3, hskonto, herfdat, hbankeinzug, hetikett, hreverse, hustid, haendherkunft, haendherkunftdat)
VALUES(:frmHalterAnl.nNebenNr,:frmHalterAnl.nHalterNr,:frmHalterAnl.strTi, :frmHalterAnl.strVN, :frmHalterAnl.strNN,:frmHalterAnl.strName2,
:frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.strLand, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
:frmHalterAnl.strAnrede,
:frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3, :frmHalterAnl.nSkonto,:frmHalterAnl.dtTAErfDat, 0,0, :frmHalterAnl.nReverse, :frmHalterAnl.strUStID,
'Tierarztpraxis', SYSDATETIME)");
												}
												this.nFetchPI = this.hSqlPI.FetchNext();
											}
											this.hSqlPI.Commit();
											this.hSqlPI.Disconnect();

										}
										// Call SqlImmedX('UPDATE LE SET
										// LEHALTERNR = :frmHalterAnl.nHalterNr,
										// LEMATCH = :frmHalterAnl.strMatch
										// WHERE ROWID = :frmHalterAnl.strROWIDLe')
										// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
										// WHERE leparztnr=:frmHalterAnl.nArztNr
										// AND lepposnr = :frmHalterAnl.nPosNr
										// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
										// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
										// TB #6
										Int.SqlImmedX(@"UPDATE LE SET
LEHALTERNR = :frmHalterAnl.nHalterNr
WHERE learztnr IN (:frmHalterAnl.nArztNr, :frmHalterAnl.nArztNr2)
AND leposnr = :frmHalterAnl.nPosNr
AND lebearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
										Int.SqlImmedX(@"UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
WHERE leparztnr IN (:frmHalterAnl.nArztNr, :frmHalterAnl.nArztNr2)
AND lepposnr = :frmHalterAnl.nPosNr
AND lepbearbeiter=:frmHalterAnl.strBearbeiter
AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
										this.SetStatusBarText("neue Nr. " + this.nHalterNr.ToString(0));
									}
								}
							}
						}
						this.nFetch = this.hSqlLe.FetchNext();
					}
					this.hSqlLe.Commit();
				}
				// If Not SalIsNull(dfArztNr2)
				// Call SqlImmedSel( 'SELECT afaelltg, amahnint, askonto, aproz1, aproz2, aproz3
				// INTO :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,  :frmHalterAnl.nSkonto,
				// :frmHalterAnl.nProz1,  :frmHalterAnl.nProz2,  :frmHalterAnl.nProz3
				// FROM A WHERE AARZTNR = :frmHalterAnl.nArztNr2')
				// Call SalStatusSetText(hWndForm,'Halternummern werden geprüft')
				// Call SqlImmedX( 'UPDATE LE SET lehalternr = 0
				// WHERE learztnr=:frmHalterAnl.nArztNr2
				// AND lebearbeiter=:frmHalterAnl.strBearbeiter
				// AND lebearbdatum=:frmHalterAnl.dtBearbDatum
				// AND NOT EXISTS ( SELECT * FROM H WHERE harztnr=learztnr AND hhalternr = lehalternr)')
				// Call SqlImmedX( 'UPDATE LEP SET lephalternr = 0
				// WHERE leparztnr=:frmHalterAnl.nArztNr2
				// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
				// AND lebearbdatum=:frmHalterAnl.dtBearbDatum
				// AND NOT EXISTS ( SELECT * FROM H WHERE harztnr=leparztnr AND hhalternr = lephalternr)')
				// Set strSelect = 'SELECT lematch, lename1,lename2,lestr,leort,leposnr, leherfdat, ROWID
				// INTO :frmHalterAnl.strMatch,:frmHalterAnl.strName1,:frmHalterAnl.strName2,
				// :frmHalterAnl.strStr,:frmHalterAnl.strOrt,:frmHalterAnl.nPosNr, :frmHalterAnl.dtTAErfDat, :frmHalterAnl.strROWIDLe
				// FROM LE WHERE learztnr=:frmHalterAnl.nArztNr2
				// AND lehalternr = 0
				// AND lebearbeiter=:frmHalterAnl.strBearbeiter
				// AND lebearbdatum=:frmHalterAnl.dtBearbDatum'
				// Call SalWaitCursor( TRUE )
				// Call SqlHandleExec(hSqlLe,strSelect,'Fehler',nCount)
				// Call SqlFetchNext(hSqlLe,nFetch)
				// While nFetch != FETCH_EOF
				// Set nHalterNr = 0
				// 01.09.00
				// If Not bAuto
				// If dtTAErfDat != DATETIME_Null
				// Call SqlImmedSel('SELECT HHALTERNR, hname1, hname2, hstr, hort FROM H INTO :frmHalterAnl.nHalterNr,
				// :frmHalterAnl.strTVN1, :frmHalterAnl.strTVN2, :frmHalterAnl.strTVStr, :frmHalterAnl.strTVOrt
				// WHERE harztnr=:frmHalterAnl.dfArztNr2 AND herfdat = :frmHalterAnl.dtTAErfDat')
				// If nHalterNr != 0
				// Set strTAxN1 = PalDelBlank(strName1)
				// Set strTAxN2 = PalDelBlank(strName2)
				// Set strTAxStr = PalDelBlank(strStr)
				// Set strTAxOrt = PalDelBlank(strOrt)
				// Set strTAxN1 = SalStrUpperX(strTAxN1)
				// Set strTAxN2 = SalStrUpperX(strTAxN2)
				// Set strTAxStr = SalStrUpperX(strTAxStr)
				// Set strTAxOrt = SalStrUpperX(strTAxOrt)
				// Set strTVxN1 = PalDelBlank(strTVN1)
				// Set strTVxN2 = PalDelBlank(strTVN2)
				// Set strTVxStr = PalDelBlank(strTVStr)
				// Set strTVxOrt = PalDelBlank(strTVOrt)
				// Set strTVxN1 = SalStrUpperX(strTVxN1)
				// Set strTVxN2 = SalStrUpperX(strTVxN2)
				// Set strTVxStr = SalStrUpperX(strTVxStr)
				// Set strTVxOrt = SalStrUpperX(strTVxOrt)
				// If strTAxN1=strTVxN1 and strTAxN2=strTVxN2 and strTAxStr=strTVxStr and strTAxOrt=strTVxOrt
				// Set nResult = 99
				// Else
				// Set nResult =  SalMessageBox('TA :  ' || strName1 || ', ' || strName2 || ', ' || strStr || ', ' || strOrt || '
				// 
				// TV :  ' || strTVN1 || ', ' || strTVN2 || ', ' || strTVStr || ', ' || strTVOrt || '
				// 
				// Kunde identifiziert. Ist das i.O. ?' , 'Achtung !' , MB_YesNo|MB_IconQuestion)
				// If nResult = IDYES
				// Call SqlImmedX('UPDATE H SET
				// hname1 = :frmHalterAnl.strName1,
				// hname2 = :frmHalterAnl.strName2,
				// hstr = :frmHalterAnl.strStr,
				// hort = :frmHalterAnl.strOrt
				// WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr = :frmHalterAnl.nHalterNr')
				// Set strKuerzel = SalStrLeftX( frmMain.strUser, 2)
				// Set lsLong = '***** automatischer Eintrag *****
				// automatische Halterstamm-Änderung aufgrund Identifikation von
				// 
				// ' || strTVN1 || '
				// ' || strTVN2 || '
				// ' ||  strTVStr || '
				// ' ||  strTVOrt || '
				// 
				// in :
				// 
				// ' || strName1 || '
				// ' || strName2 || '
				// ' ||  strStr || '
				// ' ||  strOrt || '
				// ' || PalDateToStr(dtTAErfDat)
				// Call SqlImmed('
				// INSERT INTO Z VALUES (:frmHalterAnl.strKuerzel, \'*\', :frmHalterAnl.dfArztNr2, :frmHalterAnl.nHalterNr, 0,
				// :frmHalterAnl.lsLong , SYSDATE, NULL, \'J\', \'HS\', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL)')
				// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
				// WHERE ROWID = :frmHalterAnl.strROWIDLe')
				// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
				// WHERE leparztnr=:frmHalterAnl.nArztNr2
				// AND lepposnr = :frmHalterAnl.nPosNr
				// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
				// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
				// Call SalStatusSetText(hWndForm,'alte Nr. '||SalNumberToStrX(nHalterNr,0))
				// Else If nResult = 99
				// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr
				// WHERE ROWID = :frmHalterAnl.strROWIDLe')
				// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
				// WHERE leparztnr=:frmHalterAnl.nArztNr2
				// AND lepposnr = :frmHalterAnl.nPosNr
				// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
				// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
				// Call SalStatusSetText(hWndForm,'alte Nr. '||SalNumberToStrX(nHalterNr,0))
				// Else
				// 24.10.00
				// Call SqlImmedX('UPDATE H SET herfdat = NULL
				// WHERE harztnr=:frmHalterAnl.dfArztNr AND hhalternr = :frmHalterAnl.nHalterNr')
				// Set nHalterNr = 0
				// If nHalterNr = 0
				// Set strSelect2 = 'SELECT HHALTERNR FROM H INTO :frmHalterAnl.nHalterNr
				// WHERE harztnr=:frmHalterAnl.dfArztNr2 AND @LICS(@TRIM(hname1)) = @LICS(@TRIM(:frmHalterAnl.strName1))
				// AND @LICS(@TRIM(hstr)) = @LICS(@TRIM(:frmHalterAnl.strStr))
				// AND @LICS(@TRIM(hort)) = @LICS(@TRIM(:frmHalterAnl.strOrt))'
				// If strTAN2 = ''
				// Set strSelect2 = strSelect2 || ' AND hname2 IS NULL'
				// Else
				// Set strSelect2 = strSelect2 || ' AND @LICS(@TRIM(hname2)) = @LICS(@TRIM(:frmHalterAnl.strName2)) '
				// Call SqlImmedSel(strSelect2)
				// If nHalterNr != 0
				// Call SqlImmedX('UPDATE LE SET LEHALTERNR = :frmHalterAnl.nHalterNr WHERE ROWID = :frmHalterAnl.strROWIDLe')
				// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
				// WHERE leparztnr=:frmHalterAnl.nArztNr2
				// AND lepposnr = :frmHalterAnl.nPosNr
				// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
				// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
				// Call SalStatusSetText(hWndForm,'alte Nr. '||SalNumberToStrX(nHalterNr,0))
				// Else
				// If Not bAuto
				// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr WHERE harztnr=:frmHalterAnl.dfArztNr2')
				// If Not SalIsNull(dfArztNr)
				// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr2 WHERE harztnr=:frmHalterAnl.dfArztNr')
				// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr WHERE harztnr=:frmHalterAnl.dfArztNr AND hhalternr<10000')
				// If nHalterNr = 9999
				// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr WHERE harztnr=:frmHalterAnl.dfArztNr')
				// If Not SalIsNull(dfArztNr)
				// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr2 WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr<10000')
				// If nHalterNr2 = 9999
				// Call SqlImmedSel('SELECT MAX(hhalternr) FROM H INTO :frmHalterAnl.nHalterNr2 WHERE harztnr=:frmHalterAnl.dfArztNr2')
				// If nHalterNr2>nHalterNr
				// Set nHalterNr = nHalterNr2
				// Set nHalterNr = nHalterNr +1
				// If strMatch = ''
				// Call SalModalDialog(dlgMatch, hWndForm)
				// If PalValNum( strMatch ) != 0
				// Set nHalterNr = PalValNum( strMatch )
				// Call SqlImmedX('UPDATE H SET herfdat = :frmHalterAnl.dtTAErfDat
				// WHERE harztnr=:frmHalterAnl.dfArztNr2 AND hhalternr = :frmHalterAnl.nHalterNr')
				// Else
				// Call SqlImmedX('INSERT INTO H VALUES(:frmHalterAnl.dfArztNr2,:frmHalterAnl.nHalterNr,:frmHalterAnl.strName1,:frmHalterAnl.strName2,
				// :frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
				// 0,0,0,:frmHalterAnl.strAnrede, :frmHalterAnl.strMatch,
				// :frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3,:frmHalterAnl.nSkonto,0, NULL,NULL,NULL,NULL,NULL,NULL, NULL, NULL, :frmHalterAnl.dtTAErfDat)')
				// Call SqlImmedX('INSERT INTO H VALUES(:frmHalterAnl.dfArztNr,:frmHalterAnl.nHalterNr,:frmHalterAnl.strName1,:frmHalterAnl.strName2,
				// :frmHalterAnl.strStr,:frmHalterAnl.strOrt, :frmHalterAnl.nFaellTg, :frmHalterAnl.nMahnInt,
				// 0,0,0,:frmHalterAnl.strAnrede, :frmHalterAnl.strMatch,
				// :frmHalterAnl.nProz1, :frmHalterAnl.nProz2, :frmHalterAnl.nProz3,:frmHalterAnl.nSkonto,0, NULL,NULL,NULL,NULL,NULL,NULL, NULL, NULL, :frmHalterAnl.dtTAErfDat)')
				// Call SqlImmedX('UPDATE LE SET
				// LEHALTERNR = :frmHalterAnl.nHalterNr,
				// LEMATCH = :frmHalterAnl.strMatch
				// WHERE ROWID = :frmHalterAnl.strROWIDLe')
				// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
				// WHERE leparztnr=:frmHalterAnl.nArztNr2
				// AND lepposnr = :frmHalterAnl.nPosNr
				// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
				// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
				// TB #6
				// Call SqlImmedX('UPDATE LE SET
				// LEHALTERNR = :frmHalterAnl.nHalterNr,
				// LEMATCH = :frmHalterAnl.strMatch
				// WHERE learztnr IN (:frmHalterAnl.nArztNr, :frmHalterAnl.nArztNr2)
				// AND leposnr = :frmHalterAnl.nPosNr
				// AND lebearbeiter=:frmHalterAnl.strBearbeiter
				// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
				// Call SqlImmedX('UPDATE LEP SET LEPHALTERNR = :frmHalterAnl.nHalterNr
				// WHERE leparztnr IN (:frmHalterAnl.nArztNr, :frmHalterAnl.nArztNr2)
				// AND lepposnr = :frmHalterAnl.nPosNr
				// AND lepbearbeiter=:frmHalterAnl.strBearbeiter
				// AND lebearbdatum=:frmHalterAnl.dtBearbDatum')
				// Call SalStatusSetText(hWndForm,'neue Nr. '||SalNumberToStrX(nHalterNr,0))
				// Call SqlFetchNext(hSqlLe,nFetch)
				// Call SqlCommit( hSqlLe )
				Int.SqlImmed(@"UPDATE le SET lestatus='HAnlg'
WHERE learztnr IN (:frmHalterAnl.nArztNr, :frmHalterAnl.nArztNr2)
		AND lebearbeiter=:frmHalterAnl.strBearbeiter
		AND lebearbdatum=:frmHalterAnl.dtBearbDatum");
				Sal.WaitCursor(false);
                //FC:FINAL#47 - Änderung Destroy zu Close
                //this.DestroyWindow();
				this.Close();
            }
			#endregion
		}
		
		/// <summary>
		/// pbAbbruch WindowActions Handler
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="e"></param>
		private void pbAbbruch_WindowActions(object sender, WindowActionsEventArgs e)
		{
			#region Actions
			switch (e.ActionType)
			{
				case Sys.SAM_Click:
					this.pbAbbruch_OnSAM_Click(sender, e);
					break;
			}
			#endregion
		}
		
		/// <summary>
		/// SAM_Click event handler.
		/// </summary>
		/// <param name="sender"></param>
		/// <param name="e"></param>
		private void pbAbbruch_OnSAM_Click(object sender, WindowActionsEventArgs e)
		{
			#region Actions
			e.Handled = true;
            // Call SalPostMsg(hWndForm, SAM_Close, 0, 0)
            //FC:FINAL#47 - Änderung Destroy zu Close
            //this.DestroyWindow();
			this.Close();
            #endregion
        }
		#endregion
	}
}
